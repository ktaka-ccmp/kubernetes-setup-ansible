# Usage:
#  ansible-playbook -i ./hosts ./lvs.yml -vv
#

- hosts: lvs
  sudo: yes

  vars_files:
  - vars.yml

  vars:
    other_daemons: [ 'route', 'ipvs', 'ipvs_conf' ]

  tasks:

##### keepalived

  - apt: pkg={{ item }} state=present
    with_items:
      - netcat
      - keepalived

  - local_action: shell kubectl label node {{ ansible_hostname }} lvs=yes web- --overwrite

  - template: src=./files/lvs/etc/network/if-up.d/iptables dest=/etc/network/if-up.d/iptables mode=0755
    notify: add ipt

  - file: path=/usr/service/{{ item }}/log state=directory mode=0755
    with_items:
      - "{{ other_daemons }}"

  - template: src=./files/lvs/usr/service/{{ item }}/run dest=/usr/service/{{ item }}/run mode=0700
    with_items:
      - "{{ other_daemons }}"
    notify: daemon-restart

  - template: src=./files/lvs/usr/service/{{ item }}/log/run dest=/usr/service/{{ item }}/log/run mode=0700
    with_items:
      - "{{ other_daemons }}"
    notify: daemon-restart

  - file: path=/etc/service/ state=directory mode=0755

  - file: src=/usr/service/{{ item }} dest=/etc/service/{{ item }} state=link
    with_items:
      - "{{ other_daemons }}"
    notify: daemon-restart

#  - cron: name="ipvs cronjob" job="svc -h /etc/service/ipvs"

  - modprobe: name=nf_conntrack state=present 

  - sysctl: name=net.ipv4.vs.conntrack value=1 sysctl_set=yes
  - sysctl: name=net.netfilter.nf_conntrack_max value=20000000 sysctl_set=yes
  - sysctl: name=net.nf_conntrack_max value=20000000 sysctl_set=yes

  handlers:

  - name: add ipt
    shell: /etc/network/if-up.d/iptables
    environment:
      IFACE: eth0

  - name: daemon-restart
    shell: 'svc -t /etc/service/{{ item }}'
    with_items:
      - "{{ other_daemons }}"

